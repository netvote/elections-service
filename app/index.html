<html>
<head>
	<link rel="stylesheet" href="https://hosted-sip.civic.com/css/civic-modal.min.css">
	<style>
		.loader {
			border: 8px solid #f3f3f3; /* Light grey */
			border-top: 8px solid #3498db; /* Blue */
			border-radius: 50%;
			width: 30px;
			height: 30px;
			animation: spin 2s linear infinite;
			display:none;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}
	</style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://hosted-sip.civic.com/js/civic.sip.min.js"></script>
	<!-- The most recent version  -->
	<script src="https://unpkg.com/uport-connect/dist/uport-connect.min.js"></script>

	<script>
	  var civicSip = new civic.sip({ appId: 'ryzLV3KOz' });
      var uportconnect = window.uportconnect;
      var uport = new uportconnect.Connect('Netvote Demo')
	</script>


</head>
<body>
<div id="buttons">
	<button id="civicButton" class="civic-button-a medium" type="button">
		<span>Log in with Civic</span>
	</button>

	<button id="uPortButton" class="civic-button-a medium" style="background-color: #5C58CA; text-transform : none;" type="button">
		<span>Login with uPort</span>
	</button>

	<button id="demoButton"  class="civic-button-a medium" style="background-color: #333333; text-transform : none;" type="button">
		<span>Generate Demo QR</span>
	</button>
</div>

	<div id="loader" class="loader"></div>
	<img style="display:none" src="nope.jpg" id="qr"/>
	<div id="netvoteUrl" style="display:none"></div>
<div id="startOver" style="display:none">
	<a href="/" style="font-size: 24px">Start Over</a>
</div>
	<script>

        var getUrlParam = function(name) {
            var url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        var getHashParam = function(name){
            if(window.location.hash) {
                var index = window.location.hash.indexOf(name+"=");
                if (index > -1) {
                    return window.location.hash.substring(index+((name+"=").length))
                }
            }
            return null
        };

        var uportToken = getHashParam("access_token");

		var elAddr = getUrlParam("election");
		var ELECTION_ADDRESS = (elAddr) ? elAddr : "0x9b55476fb7db47b4330f0b6b78b9415f3420ce7c";
  $(document).ready(function () {

  var civicButton = document.querySelector('#civicButton');
      civicButton.addEventListener('click', function () {
    civicSip.signup({ style: 'popup', scopeRequest: civicSip.ScopeRequests.BASIC_SIGNUP });
  });

      var uPortButton = document.querySelector("#uPortButton");
      uPortButton.addEventListener('click', function () {
          $("#loader").show();
          $("#buttons").hide();
          $("#qr").hide();
          var topic = uport.topicFactory('access_token');
          $.getJSON( `https://us-central1-netvote1.cloudfunctions.net/vote/uport/request?callbackUrl=${encodeURIComponent(topic.url)}`, function( data ) {
			  var uri = `https://id.uport.me/me?requestToken=${encodeURIComponent(data.requestToken)}`;
              uport.request({uri, topic}).then(token => {
                  sendUPortAuthToken(token);
              });
		  });
      });

  var demoButton = document.querySelector("#demoButton");
  demoButton.addEventListener('click', function () {
	  sendGenerateAuthCode();
  });

  // Listen for data
  civicSip.on('auth-code-received', function (event) {
    // encoded JWT Token is sent to the server
    var jwtToken = event.response;

    // Your function to pass JWT token to your server
      sendCivicAuthCode(jwtToken);
  });

  civicSip.on('user-cancelled', function (event) {
    /*
        event:
        {
          event: "scoperequest:user-cancelled"
        }
    */
   });

  civicSip.on('read', function (event) {
    /*
        event:
        {
          event: "scoperequest:read"
        }
    */
  });

   // Error events.
   civicSip.on('civic-sip-error', function (error) {
      // handle error display if necessary.
      console.log('   Error type = ' + error.type);
      console.log('   Error message = ' + error.message);
   });

   var displayAuthResult = function(data) {
       $("#qr").attr("src", data.qr).show();
       var netvoteUrl = "netvote://"+ELECTION_ADDRESS+"/"+data.auth.token;
       $("#netvoteUrl").html(`<a href="${netvoteUrl}">${netvoteUrl}</a>`).show();
       $("#loader").hide();
       $("#startOver").show();
       window.location.href=netvoteUrl;
   };

   var sendCivicAuthCode = function (token) {
       $("#loader").show();
       $("#buttons").hide();
       $("#qr").hide();
      $.ajax({
            url: 'https://us-central1-netvote1.cloudfunctions.net/vote/qr/civic',
            type: 'post',
            data: {
                address: ELECTION_ADDRESS
            },
            headers: {
                Authorization: 'Bearer '+token
            },
            dataType: 'json',
            success: displayAuthResult
      });
   };

   var sendUPortAuthToken = function(token) {
       $("#loader").show();
       $("#buttons").hide();
       $.ajax({
           url: 'https://us-central1-netvote1.cloudfunctions.net/vote/qr/uport',
           type: 'post',
           data: {
               address: ELECTION_ADDRESS
           },
           headers: {
               Authorization: 'Bearer '+token
           },
           dataType: 'json',
           success: displayAuthResult
       });
   }

  var sendGenerateAuthCode = function () {
      $("#loader").show();
      $("#buttons").hide();
      $("#qr").hide();
	  $.ajax({
		  url: 'https://us-central1-netvote1.cloudfunctions.net/vote/qr/generated/'+ELECTION_ADDRESS,
		  type: 'GET',
		  dataType: 'json',
		  success: displayAuthResult
	  });
  };


   if(uportToken){
       sendUPortAuthToken(uportToken);
   }

 });
	</script>
</body>

</html>